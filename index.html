<!DOCTYPE html>
<html>
  <head>
    <title>gbuesing.github.com</title>
    <meta name="viewport" content="width=device-width, maximum-scale=1.0" />
    <style>
    pre {
      float: left; 
      border: 1px dotted #ccc;
    }
    </style>
  </head>
  <body>
    <pre></pre>
  </body>
  <script>

  // http://www.radicaleye.com/lifepage/glossary.html
  // TODO: add more!
  var patterns = {
    'acorn': [
      '.*.....',
      '...*...',
      '**..***'
    ],
    'ants': [
      '**........**...**...**...**...**...**..',
      '..**.**.....**...**...**...**...**...**',
      '..**...**...**...**...**...**...**...**',
      '**.....**.**...**...**...**...**...**..',
      '.....**................................'
    ],
    'blinker': [
      '...',
      '***',
      '...'
    ],
    'gun': [
      '.........................*..........',
      '......................****....*.....',
      '.............*.......****.....*.....',
      '............*.*......*..*.........**',
      '...........*...**....****.........**',
      '**.........*...**.....****..........',
      '**.........*...**........*..........',
      '............*.*.....................',
      '.............*......................'
    ],
    'rabbits': [
      '*...***',
      '***..*.',
      '.*.....'
    ]
  };
  
  function gameOfLife(width, height) {
  
    var currentGeneration = [];
    
    function setBlankGeneration() { // wee-ooo
      var line = (new Array(width + 1)).join(' ');
      for (var i=0; i < height; i++) currentGeneration[i] = line;
    }
    
    var aliveCellRegexp = /\*/g;
    
    function addPattern(pattern, offset_x, offset_y) {      
      if (!offset_x) offset_x = parseInt((width - pattern[0].length) / 2);
      if (!offset_y) offset_y = parseInt((height - pattern.length) / 2);
      
      for (var y=0; y < pattern.length; y++) {
        var match, line = pattern[y];
        aliveCellRegexp.lastIndex = 0;
        
        while (match = aliveCellRegexp.exec(line)) {
          draw(match.index + offset_x, y + offset_y);
        }
      };
    }
  
    function calculateNextGeneration() {
      var nextGeneration = [];
      for (var y=0; y < currentGeneration.length; y++) {
        var line = currentGeneration[y];
        var nextCells = [];
        for (var x=0; x < line.length; x++) {
          var nextCell = isCellAliveInNextGeneration(x,y) ? '*' : ' ';
          nextCells.push(nextCell);
        }
        nextGeneration[y] = nextCells.join('');
      }
      return nextGeneration;
    }
  
    function isCellAlive(x,y) {
      return getCell(x,y) === '*';
    }
  
    function isCellAliveInNextGeneration(x,y) {
      var aliveNeighbors = countAliveNeighbors(x,y);
    
      if (isCellAlive(x,y)) {
        return aliveNeighbors === 2 || aliveNeighbors === 3;
      } else {
        return aliveNeighbors === 3;
      }
    }
  
    var neighborOffsets = [[-1, 0],[1, 0],[-1, 1],[0, 1],[1, 1],[-1, -1],[0, -1], [1, -1]];
  
    function countAliveNeighbors(x,y) {
      var sum = 0;
      neighborOffsets.forEach(function(pair) {
        var offset_x = pair[0], offset_y = pair[1];
        if (isCellAlive(x + offset_x, y + offset_y)) sum ++;
      });
      return sum;
    }
  
    function getCell(x,y) {
      var line = atIndex(currentGeneration, y);
      return atIndex(line, x);
    }
  
    // enables wraparound lookups on arrays and strings
    // fyi will not work with unicode strings!
    function atIndex(arr, i) {
      var length = arr.length;
      return arr[(i + length) % length];
    }
    
    function replaceCharAtIndex(str, i, replacement) {
      var length = str.length;
      if (i >= length) return str;
      return [str.slice(0,i), replacement, str.slice(i+1,str.length)].join('');
    }
    
    function draw(x,y) {
      var line = currentGeneration[y];
      if (line) {
        currentGeneration[y] = replaceCharAtIndex(line, x, '*');
      }
    }
    
    setBlankGeneration();
    
    return {
      generation: 0,
      next: function() {
        currentGeneration = calculateNextGeneration();
        this.generation ++;
      },
      toString: function() {
        return currentGeneration.join("\n")
      },
      addPattern: addPattern,
      clear: setBlankGeneration
    }
  }
  
  var elem = document.getElementsByTagName("pre")[0];
  
  var game = gameOfLife(90, 30);
  game.addPattern(patterns['gun']);
  
  var loop = setInterval(function() {
    game.next();
    elem.textContent = game.toString();
  }, 100);
  </script>
</html>